name: Build OnePlus_KernelSU-Next_KPN
on:
  workflow_dispatch:
    inputs:
      FILE:
        type: choice
        description: "配置文件 (Device Config)"
        required: true
        default: oneplus_ace2_pro_b
        options:
          - oneplus_ace2_pro_b
          - oneplus_12_b
          - oneplus_ace3_b
          - oneplus_11_b
          - oneplus_10r_v
          - oneplus_nord_3_v
          - oneplus_ace_v
          - oneplus_ace_race_v
          - oneplus_10_pro_v
          - oneplus_10t_v
          - oneplus_11r_b
          - oneplus_ace2_b
          - oneplus_pad_lite_v
          - oneplus_pad_mt6983_v
          - oneplus_ace_2v_v
          - oneplus_ace_pro_v
          - oneplus_12r_b
          - oneplus_open_b
          - oneplus_nord_ce4_b
          - oneplus_pad_go_2_b
          - oneplus_nord_ce4_lite_5g_v
          - oneplus_nord_4_b
          - oneplus_ace_3v_b
          - oneplus_pad_mt6897_v
          - oneplus_13r_b
          - oneplus_ace3_pro_b
          - oneplus_ace5_b
          - oneplus_pad_pro_b
          - oneplus_pad2_b
          - oneplus_nord_ce5_b
          - oneplus_nord_5_b
          - oneplus_ace5_pro_b
          - oneplus_13_b
          - oneplus_13t_b
          - oneplus_13s_b
          - oneplus_pad_2_pro_b
          - oneplus_pad_3_b
          - oneplus_ace5_race_b
          - oneplus_ace5_ultra_b
          - oneplus_pad2_mt6991_b
          - oneplus_ace_6
          - oneplus_ace_6t
          - oneplus_15r
          - oneplus_15
      
      BUILD_TIME:
        type: string
        description: "自定义构建时间"
        required: false
        default: "Thu Dec 11 04:17:27 UTC 2025"
      
      SUFFIX:
        type: string
        description: "自定义内核后缀"
        required: false
        default: "KSU-Next"

      KPN:
        type: boolean
        description: "启用 KPatch-Next (KPN) 及下载模块"
        required: true
        default: true

      SUSFS:
        type: boolean
        description: "启用 SUSFS (文件系统隐藏)"
        required: true
        default: true

      SCHED:
        type: boolean
        description: "启用风驰驱动 (Fengchi Scheduler)"
        required: true
        default: false
        
      DYNAMIC_REPO:
        type: string
        description: "动态清单仓库所有者"
        required: true
        default: "Numbersf"
      SPACE_NOCLEAN:
        type: boolean
        description: "是否停用空间清扫？"
        required: true
        default: false
      BUILD_NOCCACHE:
        type: boolean
        description: "是否停用此次Ccache？"
        required: true
        default: false

jobs:
  build:
    name: Build KSU-Next for ${{ github.event.inputs.FILE }}
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Build Space
        if: ${{ github.event.inputs.SPACE_NOCLEAN == 'false' }}
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Extract Manifest Info
        id: extract_info
        env:
          FILE: ${{ github.event.inputs.FILE }}
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"
          # 原始的Manifest提取逻辑
          if [[ "$FILE" =~ ^(.+)_([a-zA-Z])$ ]]; then
            FILE_CONF="${BASH_REMATCH[1]}_${BASH_REMATCH[2]}"
          else
            FILE_CONF="$FILE"
          fi
          FILE_BASE=$(echo "$FILE_CONF" | sed -E 's/_([a-zA-Z0-9])/\U\1/g; s/^oneplus/OnePlus/; s/^realme/Realme/; s/^oppo/Oppo/')
          mkdir -p ".repo/manifests_fallback"
          XML_PATH=".repo/manifests_fallback/${FILE}.xml"
          README_PATH=".repo/manifests_fallback/README.md"
          
          echo "FILE_CONF=$FILE_CONF" >> $GITHUB_ENV
          echo "FILE_BASE=$FILE_BASE" >> $GITHUB_ENV

          DYNAMIC_REPO_INPUT="${{ github.event.inputs.DYNAMIC_REPO }}"
          declare -A REPOS
          # 注意：这里之前的逻辑重复赋值了 REPOS，这里只保留最后有效的逻辑
          REPOS_URL="https://api.github.com/repos/${DYNAMIC_REPO_INPUT}/kernel_manifest"

          FOUND_REPO=""
          FOUND_BRANCH=""

          check_repo() {
            local OWNER=$1
            local REPO_URL=$2
            # 修复：使用 correct pipe 和逻辑或
            BRANCHES=$(curl -s "${REPO_URL}/branches" | jq -r '.[].name' || true)
            
            for BRANCH in $BRANCHES; do
              XML_URL="https://raw.githubusercontent.com/${OWNER}/kernel_manifest/$BRANCH/${FILE}.xml"
              README_URL="https://raw.githubusercontent.com/${OWNER}/kernel_manifest/$BRANCH/README.md"
              
              if curl -sf --head "$XML_URL" > /dev/null; then
                curl -s -o "$XML_PATH" "$XML_URL"
                curl -s -o "$README_PATH" "$README_URL" || true
                FOUND_REPO="$OWNER"
                FOUND_BRANCH="$BRANCH"
                return 0
              fi
            done
            return 1
          }

          # 1. 先尝试 OnePlusOSS
          if check_repo "OnePlusOSS" "https://api.github.com/repos/OnePlusOSS/kernel_manifest"; then
            echo "MANIFEST_REPO=OnePlusOSS" >> $GITHUB_ENV
            echo "MANIFEST_BRANCH=$FOUND_BRANCH" >> $GITHUB_ENV
          fi

          # 2. 如果没找到，尝试动态仓库
          # 修复：添加了具体的判断条件 [ -z "$FOUND_REPO" ]
          if [ -z "$FOUND_REPO" ]; then
            DYNAMIC_URL="${REPOS_URL}"
            DYNAMIC_OWNER=$(echo "$DYNAMIC_URL" | sed -E 's#https://api.github.com/repos/([^/]+)/.*#\1#')
            if check_repo "$DYNAMIC_OWNER" "$DYNAMIC_URL"; then
              echo "MANIFEST_REPO=$DYNAMIC_OWNER" >> $GITHUB_ENV
              echo "MANIFEST_BRANCH=$FOUND_BRANCH" >> $GITHUB_ENV
            fi
          fi

          # 3. 如果还是没找到，报错退出
          if [ -z "$FOUND_REPO" ]; then
            echo "❌ 无法找到 ${FILE}.xml"
            exit 1
          fi

          # 修复：grep 管道逻辑
          REVISION=$(grep -oP '<project[^>]+revision="\K[^"]+' "$XML_PATH" | head -n1 || true)
          CPU=$(echo "$REVISION" | sed -E 's#^(oneplus|realme|oppo)/([^_]+).*#\2#')
          ANDROID_VERSION=$(echo "$REVISION" | grep -oP '\d{1,2}\.\d{1,2}(\.\d{1,2})?')
          
          echo "CPU=$CPU" >> $GITHUB_ENV
          echo "ANDROID_VERSION=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "ANDROID_SHORT_VERSION=${ANDROID_VERSION%%.*}" >> $GITHUB_ENV

          # 修复：README 解析检查
          if [ -f "$README_PATH" ]; then
            BUILD_LINE=$(grep -m1 'oplus_build_kernel.sh' "$README_PATH" || true)
            if [ -n "$BUILD_LINE" ]; then
              CPUD=$(echo "$BUILD_LINE" | awk '{print $(NF-1)}')
              BUILD_METHOD=$(echo "$BUILD_LINE" | awk '{print $NF}')
              echo "CPUD=$CPUD" >> $GITHUB_ENV
              echo "BUILD_METHOD=$BUILD_METHOD" >> $GITHUB_ENV
            fi
          fi
          echo "value=${FILE_BASE}_Android${ANDROID_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create and Enable 3G Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Set Cache Environment
        if: ${{ github.event.inputs.BUILD_NOCCACHE == 'false' }}
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_${{ github.event.inputs.FILE }}" >> $GITHUB_ENV
          mkdir -p "$HOME/.ccache_${{ github.event.inputs.FILE }}"

      - name: Configure Git
        run: |
          git config --global user.name "Actions-User"
          git config --global user.email "actions@github.com"

      - name: Install Dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest 
        with: 
          packages: python3 git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip gawk dos2unix jq
          execute_install_scripts: true

      - name: Initialize Repo and Sync
        env:
          FILE: ${{ github.event.inputs.FILE }}
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          mkdir -p .repo/manifests
          cp "$GITHUB_WORKSPACE/.repo/manifests_fallback/${FILE}.xml" ".repo/manifests/${FILE}.xml"
          
          # Install Repo
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

          MANIFEST_REPO="${{ env.MANIFEST_REPO }}"
          MANIFEST_BRANCH="${{ env.MANIFEST_BRANCH }}"
          BASE_URL="https://github.com/${MANIFEST_REPO}/kernel_manifest.git"

          repo init -u "$BASE_URL" -b "$MANIFEST_BRANCH" -m "${FILE}.xml" --depth=1 --no-clone-bundle --no-tags
          repo sync -c -j$(nproc) --no-clone-bundle --no-tags --force-sync

      - name: Kernel Version Handling
        run: |
          cd kernel_workspace/kernel_platform
          for f in ./common/build.config.constants ./common/build.config.common; do
            if [ -f "$f" ]; then
              BRANCH=$(grep -m1 '^BRANCH=' "$f" | cut -d= -f2)
              [ -n "$BRANCH" ] && break
            fi
          done
          echo "KANDROID_VERSION=${BRANCH%-*}" >> $GITHUB_ENV
          echo "KERNEL_VERSION=${BRANCH#*-}" >> $GITHUB_ENV
          
          echo "KV1=${BRANCH#*-}" | cut -d. -f1 >> $GITHUB_ENV
          echo "KV2=${BRANCH#*-}" | tr -d '.' >> $GITHUB_ENV

      - name: Add KernelSU-Next (Main)
        run: |
          cd kernel_workspace/kernel_platform
          echo "Injecting KernelSU-Next Main Branch..."
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/main/kernel/setup.sh" | bash -s main

      - name: Add KPatch-Next (KPN)
        if: ${{ github.event.inputs.KPN == 'true' }}
        run: |
          cd kernel_workspace/kernel_platform
          if [ -d "common" ]; then cd common; else cd kernel; fi
          
          echo "Cloning KPatch-Next..."
          git clone https://github.com/KernelSU-Next/KPatch-Next.git drivers/kpatch_next
          
          echo "obj-y += kpatch_next/kernel/" >> drivers/Makefile
          
          CONFIG_PATH="arch/arm64/configs/gki_defconfig"
          if [ -f "$CONFIG_PATH" ]; then
            echo "Enabling KALLSYMS in $CONFIG_PATH..."
            sed -i 's/# CONFIG_KALLSYMS is not set/CONFIG_KALLSYMS=y/' "$CONFIG_PATH"
            # 修复：grep 失败时的逻辑
            grep -q "CONFIG_KALLSYMS=y" "$CONFIG_PATH" || echo "CONFIG_KALLSYMS=y" >> "$CONFIG_PATH"
            
            sed -i 's/# CONFIG_KALLSYMS_ALL is not set/CONFIG_KALLSYMS_ALL=y/' "$CONFIG_PATH"
            grep -q "CONFIG_KALLSYMS_ALL=y" "$CONFIG_PATH" || echo "CONFIG_KALLSYMS_ALL=y" >> "$CONFIG_PATH"
          else
            echo "Warning: gki_defconfig not found, manual config verification required."
          fi

      - name: Download KPatch-Next Module
        if: ${{ github.event.inputs.KPN == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching latest KPatch-Next-Module artifact from Actions..."
          
          LATEST_RUN_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/KernelSU-Next/KPatch-Next-Module/actions/runs?status=success&branch=main&per_page=1")
          
          RUN_ID=$(echo "$LATEST_RUN_JSON" | jq -r '.workflow_runs[0].id')
          
          # 修复：完善的空值检查
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
             echo "❌ Error: Failed to find a successful run for KPatch-Next-Module."
             exit 1
          fi
          
          echo "Found latest run ID: $RUN_ID"
          
          ARTIFACTS_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/KernelSU-Next/KPatch-Next-Module/actions/runs/$RUN_ID/artifacts")
            
          DOWNLOAD_URL=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[0].archive_download_url')
          
          # 修复：完善的空值检查
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
             echo "❌ Error: No artifacts found in run $RUN_ID."
             exit 1
          fi
          
          echo "Downloading module from: $DOWNLOAD_URL"
          curl -L -o KPatch-Next-Module.zip -H "Authorization: Bearer $GITHUB_TOKEN" "$DOWNLOAD_URL"
          
          mkdir -p kpn_module_temp

      - name: Apply Unicode Zero-Width Patch
        run: |
          cd kernel_workspace/kernel_platform
          if [ -d "common" ]; then cd common; fi
          
          PATCH_URL="https://raw.githubusercontent.com/tingyue123/1/main/1.patch"
          
          echo "Downloading Unicode patch from $PATCH_URL"
          curl -L -o unicode_zero_width.patch "$PATCH_URL"
          
          echo "Applying patch..."
          # 修复：patch 命令失败时不中断
          patch -p1 --fuzz=3 < unicode_zero_width.patch || echo "⚠️ Patch failed or already applied, continuing..."

      - name: Apply SUSFS Patches
        if: ${{ github.event.inputs.SUSFS == 'true' }}
        run: |
          cd kernel_workspace
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
          
          cd kernel_platform/common
          # 修复：路径中缺少空格
          cp ../../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./
          cp ../../susfs4ksu/kernel_patches/fs/* ./fs/
          cp ../../susfs4ksu/kernel_patches/include/linux/* ./include/linux/
          
          # 修复：patch 失败处理
          patch -p1 < 50_add_susfs_in_gki-${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          
          CONFIG_FILE=arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> "$CONFIG_FILE"

      - name: Apply Fengchi (SCHED)
        if: ${{ github.event.inputs.SCHED == 'true' }}
        env:
          FILE: ${{ github.event.inputs.FILE }}
          CPU: ${{ env.CPU }}
        run: |
          cd kernel_workspace/kernel_platform/common
          # 修复：失败逻辑处理
          git clone https://github.com/Numbersf/SCHED_PATCH.git -b $CPU || { echo "CPU branch not found"; exit 0; }
          
          cp ./SCHED_PATCH/fengchi_${FILE}.patch ./
          if [[ -f "fengchi_${FILE}.patch" ]]; then
            dos2unix "fengchi_${FILE}.patch"
            patch -p1 -F 3 < "fengchi_${FILE}.patch"
            echo "Fengchi applied."
          fi

      - name: Clean Extra Configs
        run: |
          cd kernel_workspace/kernel_platform/common
          CONFIG_FILE=arch/arm64/configs/gki_defconfig
          sed -i '/CONFIG_IP_SET/d' "$CONFIG_FILE"
          sed -i '/CONFIG_BBG/d' "$CONFIG_FILE"
          sed -i '/CONFIG_ZRAM_WRITEBACK/d' "$CONFIG_FILE"
          sed -i '/CONFIG_TCP_CONG_BBR/d' "$CONFIG_FILE"

      - name: Set Build Time
        run: |
          INPUT_TIME="${{ github.event.inputs.BUILD_TIME }}"
          echo "KBUILD_BUILD_TIMESTAMP=$INPUT_TIME" >> "$GITHUB_ENV"

      - name: Set Custom Suffix
        run: |
          cd kernel_workspace/kernel_platform/common
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          sed -i "s|echo \"\${KERNELVERSION}.*scm_version}\"|echo \"\${KERNELVERSION}-${SUFFIX}\"|" scripts/setlocalversion

      - name: Build Kernel
        run: |
          cd kernel_workspace/kernel_platform/common
          cd ..
          ./oplus/build/oplus_build_kernel.sh ${{ env.CPUD }} ${{ env.BUILD_METHOD }}

      - name: Pack Artifacts
        run: |
          git clone https://github.com/Numbersf/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          
          IMG=$(find kernel_workspace -name Image | head -n 1)
          cp "$IMG" AnyKernel3/
          
          if [ "${{ github.event.inputs.KPN }}" == "true" ]; then
             cp ../KPatch-Next-Module.zip ./
          fi

      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus_Kernel_KSU-Next_${{ github.event.inputs.SUFFIX }}
          path: |
            AnyKernel3/*
            *.zip